<?php

/**
 * Test class for HH_Tools_Authentication.
 * Generated by PHPUnit on 2010-09-18 at 23:00:41.
 */
class HH_Tools_AuthenticationTest extends PHPUnit_Framework_TestCase
{
    /**
     *
     * @var HH_Domain_Farmer
     */
    private $farmer;

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    protected function setUp()
    {
        $data = array(
            'id' => 999999,
            'firstName' => 'Foo',
            'lastName' => 'Bar',
            'email' => 'foo@bar.com',
            'userName' => 'testing',
            'password' => 'testing',
            'addedDatetime' => Zend_Date::now()->setTimezone('UTC'),
            'updatedDatetime' => Zend_Date::now()->setTimezone('UTC'),
            'farmId' => null,
            'role' => HH_Domain_Farmer::ROLE_ADMIN
        );
        $this->farmer = new HH_Domain_Farmer($data['id'], $data);
        $this->farmer->delete();
        $this->farmer = new HH_Domain_Farmer($data['id'], $data);
    }

    /**
     * Tears down the fixture, for example, closes a network connection.
     * This method is called after a test is executed.
     */
    protected function tearDown()
    {
        $this->farmer->delete();
    }

    public function testGetRedirectUrl()
    {
        $url = HH_Tools_Authentication::getRedirectUrl($this->farmer);
        $this->assertTrue((bool) preg_match('|^http(s)?://[a-z0-9-]+(.[a-z0-9-]+)*(:[0-9]+)?(/.*)?$|i', $url));
    }

    public function testGetExplicitRedirectUrl()
    {
        $url = HH_Tools_Authentication::getExplicitRedirectUrl($this->farmer);
        $this->assertNull($url);

        $_POST['redirect_url'] = 'https://www.' . Bootstrap::$rootDomain . '/test';

        $url = HH_Tools_Authentication::getExplicitRedirectUrl($this->farmer);
        $this->assertEquals($_POST['redirect_url'], $url);

        unset($_POST['redirect_url']);
    }

    /**
     * @todo Implement testHasExplicitRedirectUrl().
     */
    public function testHasExplicitRedirectUrl()
    {
        $this->assertFalse(HH_Tools_Authentication::hasExplicitRedirectUrl());
        $_POST['redirect_url'] = 'https://www.' . Bootstrap::$rootDomain . '/test';
        $this->assertTrue(HH_Tools_Authentication::hasExplicitRedirectUrl());
        unset($_POST['redirect_url']);
    }

    public function testClearPreAuthData()
    {
        $this->assertNull(HH_Tools_Authentication::clearPreAuthData());
    }

    public function testGetLoginRole()
    {
        $role = HH_Tools_Authentication::getLoginRole();
        $this->assertEquals(HH_Domain_Farmer::ROLE_FARMER, $role);
    }

    public function testGetReferringParentRole()
    {
        $role = HH_Tools_Authentication::getReferringParentRole();
        $this->assertEquals(HH_Domain_Farmer::ROLE_FARMER, $role);
    }

    public function testGetReferringParent()
    {
        $parent = HH_Tools_Authentication::getReferringParent();
        $this->assertNull($parent);
    }

}

?>
